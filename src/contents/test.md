# livingapi  \n## Living API server  \n[![Repo](https://img.shields.io/badge/Repo-livingapi-blue)](https://github.com/sicheo/livingapi)  \n  \nReal time server API for collaboration webapps based on   \n  \n[<h3>Convergence Server</h3>][convservgit]  \n  \n[<img alt='Convergence Logo' height='80' src='https://convergence.io/assets/img/convergence-logo.png' >][convserv]   \n  \n## Architecture  \n  \n![NewPlatform-SW Arch](https://user-images.githubusercontent.com/66950550/134783203-1a1413eb-386e-4a60-98c5-47ab77ed0bb9.png)  \n  \nThe project consists of the following components  \n- **API Server library + API Server**: this server handles authentication and permissions through the JWT. It also ensures data persistence.  \n- **API Convergence Server library**: this library allows the interface with the Convergence Server (WebSocket real time api)  \n- **Client js library for Front End**: this library (webpack bundle) exports the Convapp object that the Front End application can import and use to access collaboration services  \n  \n## Setup  \n  \nFirst, clone the livingapi  repository from git:  \n  \n```  \ngit clone  https://github.com/sicheo/livingapi.git  \n```  \n  \nThen, to install required node modules, invoke the following:  \n  \n```  \nnpm install  \n```  \nTo build the api server:  \n  \n```  \nnpm run build  \n```  \n  \n## Run the servers  \nTo use the library in your web app you need two servers up and running  \n  \n### Convergence Server  \nRun the Convergence Server with Admin Console and Orient DB. To start Convergence Server:  \n- See [here](https://github.com/convergencelabs/convergence-docker-compose) to start the server in production  \n- or use [this](https://github.com/convergencelabs/convergence-omnibus-container) for development  \n  \nIn order to use JWT authorization with Convergence Server for a given domain, setup a JWT authentication for that domain with a public key, then generate a token using private key and the KeyId associated with public key.  \n  \n### Api Server  \nTo start the API server, invoke the following:  \n```  \nnpm run testsrv  \n```  \nThe API server starts with cofiguration parameters in   \n```  \n{  \n  'HOST': '<API server binding address>',  \n  'PORT': '<API Server port>',  \n  'HTTPS': '<HTTPS mode (NO|YES>',  \n  'LOGTYPE': '<logger mode (file|stdouy)>',  \n  'USER': '<API Server initial user>',  \n  'PASSWD': '<API Server initail passwd>',  \n  'JWT_SECRET': '<JWT secret>',  \n  'KEY_ID': '<Convergence Server key id>',  \n  'CONVHOST': '<Convergence Server host/ip>',  \n  'CONVPORT': '<Cpnvergence Server Port>'  \n}  \n```  \n  \n## Usage  \n  \nTo use the library in your webapp import the script:  \n```  \n<head>  \n    <meta charset='utf-8' />  \n    <title>Some title </title>  \n    <script src='script/dist/brouser.bundle.js'></script>  \n</head>  \n```  \nThe API is accessible through the global object:  \n```  \nwindow.ConvApp  \n```  \n## Features  \n  \n- [Create new user digital twin](#Create): create new digital user and connect to Convergence Platform  \n- [Authentication/Authorization](#Authentication): api for managing authentication and authorizations  \n  - [Connection](#Connection): connect to Convergence Server  \n  - [Disconnection](#Disconnection): disconnects from Convergence Server  \n  - [User Search](#UserSearch): search user by name  \n  - [Search](#Search): search users by query  \n  - [Group](#Group): get user group  \n- [Presence Service](#Presence): presence service management api  \n  - [Subscribe](#Subscribe): subscribe to get presence event notification  \n  - [Set Presence Status](#SetPresence): set presence status  \n  - [Unsubscribe](#Unsubscribe): unsubscribe presence event notification  \n- [Shared activity](#Activity): api for managing shared activity among users  \n  - [Join/Create Avtivity](#JoinActivity): join an activity (create if not existent)  \n  - [Leave Activity](#LeaveActivity): leave an activity  \n  - [Get Participants](#GetParticipants): get the activity participants  \n  - [Remove Activity](#RemoveActivity): remove the activity  \n  - [Set Activity State](#SetActivityState): set an activity state  \n  - [Get Activity State](#GetActivityState): get the value of an activity state  \n  - [Remove Activity State](#RemoveActivityState): remove an activity state  \n  - [Clear Activity State](#ClearActivityState): clear all activity states  \n  - [Set Activity Permissions](#SetActivityPermissions): set the activity permissions  \n  - [Get Activity Permissions](#GetActivityPermissions): get the activity permissions  \n- [Shared project](#Project): api for managing shared project artifacts  \n- [Chat](#Chat): chat api  \n  - [Create Chat Room](#CreateChatRoom): create a chat room  \n  - [Create Chat Channel](#CreateChatChannel): create a chat channel  \n  - [Create Chat Direct](#CreateChatDirect): create a chat direct  \n  - [Remove Chat](#ChatRemove): remove a chat  \n  - [Join Chat](#ChatJoin): join a chat  \n  - [Send a Message](#ChatSend): send a message to the chat  \n  - [Add Users to a Channel](#ChatAdd): add users to a chat channel  \n  - [Leave Chat](#ChatLeave): leave a chat  \n  - [Change Chat Name](#ChatChangeName): change chat name  \n  - [Change Chat Topic](#ChatChangeTopic): change chat topic  \n  - [Get Chat Info](#ChatGetInfo): get chat info  \n  \n  \n### Create  \n[![codecov](https://img.shields.io/static/v1?label=navigation&message=up&color=yellow)](#Features)  \n  \nTo create new digital user and connect to Convergence with JWT use:  \n```  \n        const baseapiurl = 'http://<apiserver>:<apiport>/living/v1/convergence';  \n        const convergenceurl = 'http://<convergenceserver>:<convergenceport>/api/realtime/convergence/living'  \n  \n        const apiconn = new window.ConvApp.JwtApi(baseapiurl);  \n  \n        const jwtconn = new window.ConvApp.JwtConnection(convergenceurl, apiconn);  \n  \n        const userjwt = new window.ConvApp.Brouser('user@mail.com', jwtconn);  \n```  \nThe instance *userjwt* now contains all the collaboration API. Each API call is asyncronous (returns a Promise). Each API call emits an event. The caller can listen to the event and will be notified when the call completes (or if an error occurs).  \n  \n### Authentication  \n#### Connection  \n[![codecov](https://img.shields.io/static/v1?label=navigation&message=up&color=yellow)](#Features)  \n  \nTo connect the user to Convergence Server use:  \n```  \nuserjwt.connect({ user: 'user@mail.com', password: 'password' })  \n```  \nYou can subscribe to the connection event using:  \n```  \nuserjwt.emitter.on(Brouser.EVT_CONNECTED, async (res: any) => {  \n        ...do whatever you need to do...  \n    })  \n```  \nThe ```res``` object returned by the event listerner is the following:  \n```  \n{  \n  domain: <domainId>  \n  session: <sessionId>  \n}  \n```  \n#### Disconnection  \n[![codecov](https://img.shields.io/static/v1?label=navigation&message=up&color=yellow)](#Features)  \n  \nTo disconnect the user from Convergence Server use:  \n```  \nuserjwt.disconnect()  \n```  \nYou can subscribe to the disconnection event using:  \n```  \nuserjwt.emitter.on(Brouser.EVT_DISCONNECTED, async (id: any ) => {  \n        ...do whatever you need to do...  \n    })  \n```  \n#### UserSearch  \n[![codecov](https://img.shields.io/static/v1?label=navigation&message=up&color=yellow)](#Features)  \n  \nTo get user info by username use:  \n```  \nuserjwt.searchUser('user@mail.com')  \n```  \nYou can subscribe to the user search event using:  \n```  \nuserjwt.emitter.on(Brouser.EVT_SEARCHUSER, (user: any) => {  \n        ...do whatever you need to do...  \n    })  \n```  \nThe ```user``` object returned by the event listener is the following:  \n```  \n{  \n  {'userType':'normal',   \n  'username':'user@mail.com',   \n  'firstName':'User First Name',   \n  'lastName':'User Last Name',   \n  'displayName':'User Display Name',   \n  'email':'user@mail.com',   \n  'anonymous':false,   \n  'convergence':false,   \n  'normal':true,   \n  'userId':{'userType':'normal','username':'user@mail.com','_guid':'normal:user@mail.comu'}}  \n}  \n```  \n#### Search  \n[![codecov](https://img.shields.io/static/v1?label=navigation&message=up&color=yellow)](#Features)  \n  \nTo get user info by query use:  \n```  \nconst query = { fields: ['firstName', 'lastName'], term: 'searchterm', offset: 0, limit: 10, orderBy: { field: 'lastName', ascending: true } }  \nawait userjwt.search(query)  \n```  \nYou can subscribe to the user search event using:  \n```  \nuserjwt.emitter.on(Brouser.EVT_SEARCH, (users: any) => {  \n        ...do whatever you need to do...  \n    })  \n```  \nThe ```users``` returned by the event listener is an array of ```user``` objects:  \n```  \n[{  \n  {'userType':'normal',   \n  'username':'user1@mail.com',   \n  'firstName':'User1 First Name',   \n  'lastName':'User1 Last Name',   \n  'displayName':'User1 Display Name',   \n  'email':'user1@mail.com',   \n  'anonymous':false,   \n  'convergence':false,   \n  'normal':true,   \n  'userId':{'userType':'normal','username':'user1@mail.com','_guid':'normal:user1@mail.comu'}}  \n},  \n{  \n  {'userType':'normal',   \n  'username':'user2@mail.com',   \n  'firstName':'User2 First Name',   \n  'lastName':'User2 Last Name',   \n  'displayName':'User2 Display Name',   \n  'email':'use2r@mail.com',   \n  'anonymous':false,   \n  'convergence':false,   \n  'normal':true,   \n  'userId':{'userType':'normal','username':'user2@mail.com','_guid':'normal:user2@mail.comu'}}  \n}]  \n```  \n  \n#### Group  \n[![codecov](https://img.shields.io/static/v1?label=navigation&message=up&color=yellow)](#Features)  \n  \nTo get group info use:  \n```  \nuserjwt.getGroup()  \n```  \nYou can subscribe to the get group event using:  \n```  \nuserjwt.emitter.on(Brouser.EVT_GETGROUP, (group: any) => {  \n        ...do whatever you need to do...  \n    })  \n```  \nThe ```group``` object returned by the event listener is the following:  \n```  \n{  \n'id':'GroupId',  \n'description':'Group Description',  \n'members':['user1@mail1.com','user2@mail2.com','user3@mail3.com']  \n}  \n```  \n  \n### Presence  \n  \n#### Subscribe  \n[![codecov](https://img.shields.io/static/v1?label=navigation&message=up&color=yellow)](#Features)  \n  \nTo subscribe to userlist (buddies) events use:  \n```  \nuserjwt.subscribe()  \n```  \nYou can get presence state change event using:  \n```  \nuserjwt.emitter.on(Brouser.EVT_PRESENCESTATE, (ret: any) => {  \n        ...do whatever you need to do...  \n    })  \n```  \nThe ```ret``` object returned by the event listerner is the following:  \n```  \n{  \n  evt: 'status_set'  \n  state: 'offline'|'available'|'dnd'|'away'  \n}  \n```  \n#### SetPresence  \n[![codecov](https://img.shields.io/static/v1?label=navigation&message=up&color=yellow)](#Features)  \n  \nTo change the presence status of the user use:  \n```  \nuserjwt.status = 'available'|'dnd'|'away'  \n```  \n  \n#### Unsubscribe  \n[![codecov](https://img.shields.io/static/v1?label=navigation&message=up&color=yellow)](#Features)  \n  \nTo unsubscribe to userlist (buddies) events use:  \n```  \nuserjwt.unsubscribeAll()  \n```  \n  \n### Activity  \n  \n#### JoinActivity  \n[![codecov](https://img.shields.io/static/v1?label=navigation&message=up&color=yellow)](#Features)  \n  \nTo join an existing activity (or create if it doesn't exists) use:  \n```  \nuserjwt.joinActivity('<activity-type>', '<activity-id>')  \n```  \n***You can join only one activity at time. You need to leave the activity if you want to join another one***  \nYou can subscribe to the join activity event using:  \n```  \nuserjwt.emitter.on(Brouser.EVT_ACTIVITYSESSIONJOINED, (res: any) => {  \n        ...do whatever you need to do...  \n    })  \n```  \nThe ```res``` object returned by the event listerner is the following:  \n```  \n{  \n  participant: joined participant object  \n}  \n```  \nThe ```participant``` object is as follows:  \n```  \n{  \n  activity: The Activity this participant belongs too.  \n  sessionId: The session id of the participant.  \n  user: The username of the participant.  \n  local: A flag indicating if the participant represents the local user / session.  \n  state: The state of this participant within the activity.  \n}  \n```  \n#### LeaveActivity  \n[![codecov](https://img.shields.io/static/v1?label=navigation&message=up&color=yellow)](#Features)  \n  \nTo leave an existing activity use:  \n```  \nuserjwt.leaveActivity()  \n```  \nYou can subscribe to the leave activity event using:  \n```  \nuserjwt.emitter.on(Brouser.EVT_ACTIVITYSESSIONLEFT, (res: any) => {  \n        ...do whatever you need to do...  \n    })  \n```  \nThe ```res``` object returned by the event listerner is the following:  \n```  \n{  \n  activity: The Activity this participant belongs too.  \n  user: The username of the participant.  \n  sessionId: The session id of the participant.  \n}  \n```  \n#### GetParticipants  \n[![codecov](https://img.shields.io/static/v1?label=navigation&message=up&color=yellow)](#Features)  \n  \nTo get the list of activity participants use:  \n```  \nuserjwt.getParticipants()  \n```  \nYou can subscribe to the get activity participants event using:  \n```  \nuserjwt.emitter.on(Brouser.EVT_ACTIVITYGETPARTICIPANTS, (res: any) => {  \n        ...do whatever you need to do...  \n    })  \n```  \nThe ```res``` object returned by the event listerner is the an array of ```participant``` objects:  \n```  \n[  \n  participant1, participant2, participant3  \n]  \n```  \n  \n#### RemoveActivity  \n[![codecov](https://img.shields.io/static/v1?label=navigation&message=up&color=yellow)](#Features)  \n  \nTo remove an activity use (you must have permission to remove):  \n```  \nuserjwt.removeActivity()  \n```  \nYou can subscribe to the remove activity event using:  \n```  \nuserjwt.emitter.on(Brouser.EVT_ACTIVITYDELETED, (res: any) => {  \n        ...do whatever you need to do...  \n    })  \n```  \nThe ```res``` object returned by the event listerner is:  \n```  \n{  \n  activity: The Activity deleted.  \n  user: The username.  \n  sessionId: The session id.  \n}  \n```  \n#### SetActivityState  \n[![codecov](https://img.shields.io/static/v1?label=navigation&message=up&color=yellow)](#Features)  \n  \nTo set an activity state use:  \n```  \nuserjwt.setActivityState('<state name>', '<state value>')  \n```  \nYou can subscribe to the set activity state event using:  \n```  \nuserjwt.emitter.on(Brouser.EVT_ACTIVITYSTATESET, (res: any) => {  \n        ...do whatever you need to do...  \n    })  \n```  \nThe ```res``` object returned by the event listerner is:  \n```  \n{  \n  activity: The Activity this participant belongs too.  \n  sessionId: The session id of the participant.  \n  user: The username of the participant.  \n  local: A flag indicating if the participant represents the local user / session.  \n  state: The state of this participant within the activity.  \n  key: the state that was modified.  \n  value: the value of the state.  \n}  \n```  \n  \n#### GetActivityState  \n[![codecov](https://img.shields.io/static/v1?label=navigation&message=up&color=yellow)](#Features)  \n  \nTo get an activity state use:  \n```  \nconst res = userjwt.getActivityState('<state name>')  \n```  \nThe ```res``` object returned is a string with the state value.  \n  \n  \n#### RemoveActivityState  \n[![codecov](https://img.shields.io/static/v1?label=navigation&message=up&color=yellow)](#Features)  \n  \nTo remove an activity state use:  \n```  \nuserjwt.removeActivityState('<state name>')  \n```  \nYou can subscribe to the remove activity state event using:  \n```  \nuserjwt.emitter.on(Brouser.EVT_ACTIVITYSTATEREMOVED, (res: any) => {  \n        ...do whatever you need to do...  \n    })  \n```  \nThe ```res``` object returned by the event listerner is:  \n```  \n{  \n  activity: The Activity this participant belongs too.  \n  sessionId: The session id of the participant.  \n  user: The username of the participant.  \n  local: A flag indicating if the participant represents the local user / session.  \n  state: The state of this participant within the activity.  \n  key: the state that was removed  \n}  \n```  \n  \n#### ClearActivityState  \n[![codecov](https://img.shields.io/static/v1?label=navigation&message=up&color=yellow)](#Features)  \n  \nTo remove all the activity states use:  \n```  \nuserjwt.clearActivityState()  \n```  \nYou can subscribe to the clear activity state event using:  \n```  \nuserjwt.emitter.on(Brouser.EVT_ACTIVITYSTATECLEARED, (res: any) => {  \n        ...do whatever you need to do...  \n    })  \n```  \nThe ```res``` object returned by the event listerner is:  \n```  \n{  \n  activity: The Activity this participant belongs too.  \n  sessionId: The session id of the participant.  \n  user: The username of the participant.  \n  local: A flag indicating if the participant represents the local user / session.  \n  state: The state of this participant within the activity.  \n}  \n```  \n  \n#### SetActivityPermissions  \n[![codecov](https://img.shields.io/static/v1?label=navigation&message=up&color=yellow)](#Features)  \n  \nTo set activity permissions use:  \n```  \n// For group  \nconst perms = { '<GroupName>': ['join', 'lurk', 'view_state', 'set_state'] }  \nuserjwt.setActivityPermissions('group', perms)  \n// for user  \nconst perms = { '<UserName>': ['join', 'lurk', 'set_state', 'view_state', 'manage', 'remove'] }  \nuserjwt.setActivityPermissions('user', perms)  \n// for everyone  \nconst perms = { 'world': ['join', 'lurk', 'view_state'] }  \nuserjwt.setActivityPermissions('world', perms)  \n```  \nYou can subscribe to the set activity state permissions event using:  \n```  \nuserjwt.emitter.on(Brouser.EVT_ACTIVITYSETPERMISSIONS, (res: any) => {  \n        ...do whatever you need to do...  \n    })  \n```  \nThe ```res``` object returned by the event listerner is:  \n```  \n{  \n  type: permission type.  \n  permissions: permissions setted  \n}  \n```  \n  \n#### GetActivityPermissions  \n[![codecov](https://img.shields.io/static/v1?label=navigation&message=up&color=yellow)](#Features)  \n  \nTo get activity permissions use:  \n```  \nconst ret = userjwt.getActivityPermissions('<type>')  \n```  \nThe ```ret``` object returned is an array of string of permissions.  \n  \n### Project  \n  \nTBD  \n  \n### Chat  \n  \n#### CreateChatRoom  \n[![codecov](https://img.shields.io/static/v1?label=navigation&message=up&color=yellow)](#Features)  \n  \nTo create a chat room use:  \n```  \nuserjwt.createRoomChat('ROOM_NAME', 'ROOM_TOPIC')  \n```  \n  \n#### CreateChatChannel  \n[![codecov](https://img.shields.io/static/v1?label=navigation&message=up&color=yellow)](#Features)  \n  \nTo create a chat channel use:  \n```  \nuserjwt.createChannelChat('CHANNEL_NAME', 'CHANNEL_TOPIC')  \n```  \n  \n#### CreateChatDirect  \n[![codecov](https://img.shields.io/static/v1?label=navigation&message=up&color=yellow)](#Features)  \n  \nTo create a chat Direct with *user1@mail.com*, *user2@mail2.com*, use:  \n```  \nuserjwt.createDirectChat(['user1@mail.com', 'user2@mail2.com'])  \n```  \n#### ChatRemove  \n[![codecov](https://img.shields.io/static/v1?label=navigation&message=up&color=yellow)](#Features)  \n  \nTo remove a chat  use:  \n```  \nuserjwt.chatRemove('CHAT_NAME')  \n```  \nYou can subscribe to the chat remove event using:  \n```  \nuserjwt.emitter.on(Brouser.EVT_CHATREMOVED, (res: any) => {  \n        ...do whatever you need to do...  \n    })  \n```  \nThe ```res``` object returned by the event listerner is:  \n```  \n{  \n  cahtId: chat Id  \n}  \n```  \n  \n#### ChatJoin  \n[![codecov](https://img.shields.io/static/v1?label=navigation&message=up&color=yellow)](#Features)  \n  \nTo join a chat  use:  \n```  \nuserjwt.chatJoin('CHAT_NAME')  \n```  \nYou can subscribe to the chat join event using:  \n```  \nuserjwt.emitter.on(Brouser.EVT_CHATJOIN, async (res: any) => {  \n        ...do whatever you need to do...  \n    })  \n```  \nThe ```res``` object returned by the event listerner is:  \n```  \n{  \n  cahtId: chat Id  \n}  \n```  \n  \n#### ChatSend  \n[![codecov](https://img.shields.io/static/v1?label=navigation&message=up&color=yellow)](#Features)  \n  \nTo send a message to a chat room or a chat channel  use:  \n```  \nuserjwt.chatSend('CHAT_NAME','This is my message')  \n```  \nTo send a message to a direct chat room   use:  \n```  \nuserjwt.chatSend('CHAT_NAME','This is my message', true)  \n```  \nYou can subscribe to the chat send event using:  \n```  \nuserjwt.emitter.on(Brouser.EVT_CHATMESSAGE, (res: any) => {  \n        ...do whatever you need to do...  \n    })  \n```  \nThe ```res``` object returned by the event listerner is:  \n```  \n{  \n  message: message sent to the chat  \n}  \n```  \n  \n#### ChatAdd  \n[![codecov](https://img.shields.io/static/v1?label=navigation&message=up&color=yellow)](#Features)  \n  \nTo add a user to a chat channel  use:  \n```  \nuserjwt.chatSend('CHAT_NAME','user1@mail.com')  \n```  \nYou can subscribe to the chat user add event using:  \n```  \nuserjwt.emitter.on(Brouser.EVT_CHATUSERADDED, (res: any) => {  \n        ...do whatever you need to do...  \n    })  \n```  \nThe ```res``` object returned by the event listerner is:  \n```  \n{  \n  user: user added to the chat  \n}  \n```  \n  \n#### ChatLeave  \n[![codecov](https://img.shields.io/static/v1?label=navigation&message=up&color=yellow)](#Features)  \n  \nTo leave a chat use:  \n```  \nuserjwt.chatLeave('CHAT_NAME')  \n```  \nYou can subscribe to the chat leave event using:  \n```  \nuserjwt.emitter.on(Brouser.EVT_CHATLEFT, (res: any) => {  \n        ...do whatever you need to do...  \n    })  \n```  \nThe ```res``` object returned by the event listerner is:  \n```  \n{  \n  cahtId: chat Id  \n}  \n```  \n  \n  \n#### ChatChangeName  \n[![codecov](https://img.shields.io/static/v1?label=navigation&message=up&color=yellow)](#Features)  \n  \nTo change tha chat name use:  \n```  \nuserjwt.chatChangeName('CHAT_NAME','NEW_CHAT_NAME')  \n```  \nYou can subscribe to the chat change name event using:  \n```  \nuserjwt.emitter.on(Brouser.EVT_CHATNAMECHANGED, (res: any) => {  \n        ...do whatever you need to do...  \n    })  \n```  \nThe ```res``` object returned by the event listerner is:  \n```  \n{  \n  cahtName: new chat name  \n}  \n```  \n  \n#### ChatChangeTopic  \n[![codecov](https://img.shields.io/static/v1?label=navigation&message=up&color=yellow)](#Features)  \n  \nTo change tha chat name use:  \n```  \nuserjwt.chatChangeTopic('CHAT_TOPIC','NEW_CHAT_TOPIC')  \n```  \nYou can subscribe to the chat change topic event using:  \n```  \nuserjwt.emitter.on(Brouser.EVT_CHATTOPICCHANGED, (res: any) => {  \n        ...do whatever you need to do...  \n    })  \n```  \nThe ```res``` object returned by the event listerner is:  \n```  \n{  \n  topic: new chat topic  \n}  \n```  \n  \n#### ChatGetInfo  \n[![codecov](https://img.shields.io/static/v1?label=navigation&message=up&color=yellow)](#Features)  \n  \nTo get tha chat info use:  \n```  \nuserjwt.chatGetInfo('CHAT_NAME')  \n```  \n  \n  \n[//]: #   \n  \n   [convserv]: <https://convergence.io/quickstart/>  \n   [convservgit]: <https://github.com/convergencelabs/convergence-server>  \n
